<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://deshritbaral.com.np/feed.xml" rel="self" type="application/atom+xml" /><link href="https://deshritbaral.com.np/" rel="alternate" type="text/html" /><updated>2025-11-09T19:19:50+00:00</updated><id>https://deshritbaral.com.np/feed.xml</id><title type="html">Deshrit Baral</title><entry><title type="html">Tuning a PID Controller</title><link href="https://deshritbaral.com.np/blog/2024/09/25/tuning-PID-controller" rel="alternate" type="text/html" title="Tuning a PID Controller" /><published>2024-09-25T00:00:00+00:00</published><updated>2024-09-25T00:00:00+00:00</updated><id>https://deshritbaral.com.np/blog/2024/09/25/tuning-PID-controller</id><content type="html" xml:base="https://deshritbaral.com.np/blog/2024/09/25/tuning-PID-controller"><![CDATA[<p>If you’ve ever tried to control the speed of a motor, balance a robot, or maintain a 
stable temperature with an Arduino or any other micro-controller, chances are you’ve 
come across something called a <strong>PID controller</strong>. At first, PID might look complicated 
with all its math and jargon—but its actually a simple concept! Today, I will 
break it down for you in simple terms so that you can quickly learn how to implement 
it in your own projects.</p>

<hr />

<h2 id="what-is-a-pid-controller">What is a PID Controller?</h2>

<p>PID stands for:</p>
<ul>
  <li><strong>P</strong>: Proportional</li>
  <li><strong>I</strong>: Integral</li>
  <li><strong>D</strong>: Derivative</li>
</ul>

<p>Think of it like this:</p>

<ul>
  <li><strong>P</strong> is how hard you push toward your goal.</li>
  <li><strong>I</strong> keeps track of how far you’ve been off the goal over time and nudges you to 
fix it.</li>
  <li><strong>D</strong> watches how fast you’re approaching the goal and prevents you from overshooting.</li>
</ul>

<p>All three work together to reach your target smoothly and accurately.</p>

<hr />

<h2 id="implementing-pid-controller-in-code">Implementing PID Controller in Code</h2>

<p>Writing the PID logic in code has to be the easiest part of all. There are only few 
thing to keep in mind.</p>

<ul>
  <li>Constant main loop</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loop_timer</span><span class="p">;</span>

<span class="n">loop_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="cm">/* Read sensor value */</span>

  <span class="cm">/* PID code */</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">micros</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_timer</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">);</span>
  <span class="n">loop_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Calculate error</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">error</span><span class="p">,</span> <span class="n">prev_error</span><span class="p">;</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">set_point</span> <span class="o">-</span> <span class="n">sensor_value</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Calculate <strong>p</strong> value</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">p</span><span class="p">;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">kp</span> <span class="o">*</span> <span class="n">error</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Calculate <strong>d</strong> value</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">d</span><span class="p">;</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">kd</span> <span class="o">*</span> <span class="p">(</span><span class="n">prev_error</span> <span class="o">-</span> <span class="n">error</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Calculate <strong>i</strong> value</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">i</span><span class="p">;</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">error</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Total PID value</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">output</span><span class="p">;</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">d</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<h2 id="tuning-the-pid-constants">Tuning the PID Constants</h2>

<p>Now all you have to do is change the values of <code class="language-plaintext highlighter-rouge">kp</code>, <code class="language-plaintext highlighter-rouge">ki</code> and <code class="language-plaintext highlighter-rouge">kd</code> such that you get 
desired output from your system.</p>

<ol>
  <li>
    <p>Start with only one constant <code class="language-plaintext highlighter-rouge">kp</code>, like <code class="language-plaintext highlighter-rouge">kp = 2.0, ki = 0, kd = 0</code> and observe the 
output. Tweak this value so that you get optimum possible outcome.</p>
  </li>
  <li>
    <p>Next, start assuming <code class="language-plaintext highlighter-rouge">kd,</code> yeah <code class="language-plaintext highlighter-rouge">kd</code> not <code class="language-plaintext highlighter-rouge">ki</code>. We secondly tune <code class="language-plaintext highlighter-rouge">kd</code> because, it 
dampens the over and under shoot created by <code class="language-plaintext highlighter-rouge">kp</code>. You might need to go back to <code class="language-plaintext highlighter-rouge">kp</code> 
and tweak it to tune this value properly.</p>
  </li>
  <li>
    <p>Finally, tune the <code class="language-plaintext highlighter-rouge">ki</code>. For the many systems you might not even need <code class="language-plaintext highlighter-rouge">ki</code>. You have 
to think slightly differently for constant <code class="language-plaintext highlighter-rouge">ki</code> because if you see above mathematical 
expression for the value associated with <code class="language-plaintext highlighter-rouge">ki</code> which is—<code class="language-plaintext highlighter-rouge">i</code>, depends on previous values 
of <code class="language-plaintext highlighter-rouge">i</code> meaning it is integrating all the values over many loops whereas for <code class="language-plaintext highlighter-rouge">d</code> you 
only need what previous <code class="language-plaintext highlighter-rouge">error</code> value was, meaning it is accounting for how large the 
difference in <code class="language-plaintext highlighter-rouge">error</code> is between the loops and finally for <code class="language-plaintext highlighter-rouge">kp</code>, it just needs the 
current <code class="language-plaintext highlighter-rouge">error</code>.</p>
  </li>
</ol>

<hr />

<h2 id="other-important-points">Other Important Points</h2>

<ol>
  <li>
    <p>Calibrating the sensor—You might need to add offset values depending upon the type 
and quality of sensor used in the project.</p>
  </li>
  <li>
    <p>Skip the processing in deadzone—As we know the total PID value is the direct output 
to the actuator, suppose, for a balancing robot in a <em>single axis</em>, if the sensor 
output value in degree is \(0^\circ\) when perfectly vertical, then possible deadzone 
range (depending upon the type of sensors, motors etc.) can be \(\pm2^\circ\), where 
processing the PID value can be completely skipped and simply set to 0.</p>
  </li>
  <li>
    <p>Also Keep in account for the actuator deadzone—If you are using an arduino to drive 
a motor with a motor driver, you have to give out PWM value from any analog pin to the 
driver, which generally in code value from 0 to 255 and you might have noticed the 
motor does not immediately start moving in initial values maybe even for upto 10 or 20, 
this maximum value until when the motor does not start moving is the actuator deadzone. 
And to fix this problem simply add this value 20 to PID output or you can also map your 
PID value to range 20 to 255 of motor driver output.</p>
  </li>
  <li>
    <p>Clamp the PID value to your actuator range—Suppose if your total PID value came out 
to be 257 to give it to your motor driver which should be only between range 0 to 255, 
the value might overflow as 2. So better clamp the value \(\gt\) 255 to 255 and 
\(\lt\) 0 to 0.</p>
  </li>
</ol>

<hr />

<h2 id="combining-everything">Combining Everything</h2>

<p>A typical setup looks like this:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Arduino.h&gt;</span><span class="cp">
</span>
<span class="cm">/* Required variables */</span>
<span class="kt">float</span> <span class="n">sensor_value</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">set_point</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">prev_error</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loop_timer</span><span class="p">;</span>

<span class="cm">/* PID parameters */</span>
<span class="kt">float</span> <span class="n">Kp</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">Kd</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

<span class="cm">/* Utility functions */</span>
<span class="kt">float</span> <span class="nf">read_sensor</span><span class="p">()</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="n">drive_motor</span><span class="p">(</span><span class="kt">float</span> <span class="n">value</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="cm">/* Required setup code ... */</span>
  
  <span class="n">loop_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="cm">/* Read sensor value */</span>
  <span class="n">sensor_value</span> <span class="o">=</span> <span class="n">read_sensor</span><span class="p">();</span>

  <span class="cm">/* PID code */</span>
  <span class="n">error</span> <span class="o">=</span> <span class="n">set_point</span> <span class="o">-</span> <span class="n">sensor_value</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">kp</span> <span class="o">*</span> <span class="n">error</span><span class="p">;</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">kd</span> <span class="o">*</span> <span class="p">(</span><span class="n">prev_error</span> <span class="o">-</span> <span class="n">error</span><span class="p">);</span>
  <span class="n">prev_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">error</span><span class="p">;</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">d</span><span class="p">;</span>

  <span class="cm">/* Driving the actuator */</span>
  <span class="n">drive_motor</span><span class="p">(</span><span class="n">output</span><span class="p">);</span>

  <span class="cm">/* Constant 250Hz main loop */</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">micros</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_timer</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">);</span>
  <span class="n">loop_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>]]></content><author><name></name></author><category term="jekyll" /><category term="update" /><summary type="html"><![CDATA[If you’ve ever tried to control the speed of a motor, balance a robot, or maintain a stable temperature with an Arduino or any other micro-controller, chances are you’ve come across something called a PID controller. At first, PID might look complicated with all its math and jargon—but its actually a simple concept! Today, I will break it down for you in simple terms so that you can quickly learn how to implement it in your own projects.]]></summary></entry></feed>