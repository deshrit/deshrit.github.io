<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://deshritbaral.com.np/feed.xml" rel="self" type="application/atom+xml" /><link href="https://deshritbaral.com.np/" rel="alternate" type="text/html" /><updated>2026-02-12T19:29:17+00:00</updated><id>https://deshritbaral.com.np/feed.xml</id><title type="html">Deshrit Baral</title><entry><title type="html">Understanding Transfer Learning With Pretrained VGG16 Network</title><link href="https://deshritbaral.com.np/blog/2025/05/06/transfer-learning" rel="alternate" type="text/html" title="Understanding Transfer Learning With Pretrained VGG16 Network" /><published>2025-05-06T00:00:00+00:00</published><updated>2025-05-06T00:00:00+00:00</updated><id>https://deshritbaral.com.np/blog/2025/05/06/transfer-learning</id><content type="html" xml:base="https://deshritbaral.com.np/blog/2025/05/06/transfer-learning"><![CDATA[<p>Transfer learning is a powerful machine learning technique where a trained models’ 
parameters are reused instead of training from scratch in order to fine tune on 
specific dataset for specialized problem.</p>

<p>In this blog, we will try to understand transfer learning through hands on experience 
with PyTroch framework using pretrained <a href="https://arxiv.org/abs/1409.1556">VGG16</a> network
trained on <a href="https://www.image-net.org/">ImageNet</a> dataset on to 
new <a href="https://www.microsoft.com/en-us/download/details.aspx?id=54765">Cat and Dogs</a> dataset.</p>

<hr />

<h2 id="why-transfer-learning">Why Transfer Learning?</h2>

<p>Training a large convolutional neural network from scratch reqiuires millions of 
labeled images, significant GPU compute and long training time. Instead, with this learning
technique we can simply load a pretrained model trained on generalized dataset like <a href="https://www.image-net.org/">ImageNet</a> (1.2 million images),
replace the final classification layer and train only the last few layers (or we can fine tune entire model).</p>

<hr />

<h2 id="about-vgg16">About VGG16</h2>

<p>VGG (Visual Geometry Group) was the name of the team participating in <a href="https://www.image-net.org/challenges/LSVRC/2014/index.php">ILSVRC - 2014</a>
from University of oxford, Department of Engineering Science. Their one of the purposed network 
architecture with 16 layers (convolutional and dense layers) was called VGG16. The 
original paper explaining everything in detail about VGG networks is available in
<a href="https://arxiv.org/abs/1409.1556">arxiv</a>.</p>

<p>The pretrained VGG16 model, as the name says, is 16 layers deep with 13 convolutional 
layers and 3 fully connected layers. It is trained on ImageNet dataset with 1,000 object
categories. The input image size to the model was 224 x 224 pixels. The model used 
3x3 convolutional filters throughout the network and ended with fully connected classifier
followed by a softmax layer for classification.</p>

<hr />

<h2 id="download-and-extract-dataset">Download and Extract Dataset</h2>

<p>Download the <a href="https://www.microsoft.com/en-us/download/details.aspx?id=54765">Cat and Dogs</a> 
dataset and extract the zip file. You will get the dataset directory as <code class="language-plaintext highlighter-rouge">kagglecatsanddogs_5340</code> 
and inside cut <code class="language-plaintext highlighter-rouge">PetImages</code> directory and paste at the project root or if comfortable 
leave as is and update the path.</p>

<hr />

<h2 id="step-1-install-and-import-libraries">Step 1: Install and Import libraries</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span>

<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">v2</span>
</code></pre></div></div>

<hr />

<h2 id="step-2-custom-dataset-class">Step 2: Custom Dataset Class</h2>

<p>In order to train a PyTorch model we should create compatible dataset and data loaders.
To learn more about them study <a href="https://docs.pytorch.org/tutorials/beginner/basics/data_tutorial.html">here</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CatDogDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_dir</span> <span class="o">=</span> <span class="s">"PetImages"</span><span class="p">,</span> <span class="n">transforms</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span> 
        
        <span class="bp">self</span><span class="p">.</span><span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Cat"</span><span class="p">,</span> <span class="s">"Dog"</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s">"Cat"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Dog"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">image_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="n">class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">img_name</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">class_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">img_name</span><span class="p">.</span><span class="n">lower</span><span class="p">().</span><span class="n">endswith</span><span class="p">((</span><span class="s">".png"</span><span class="p">,</span> <span class="s">".jpg"</span><span class="p">,</span> <span class="s">".jpeg"</span><span class="p">)):</span>
                    <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_dir</span><span class="p">,</span> <span class="n">img_name</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                            <span class="n">img</span><span class="p">.</span><span class="n">verify</span><span class="p">()</span>
                        
                        <span class="bp">self</span><span class="p">.</span><span class="n">image_paths</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">class_to_id</span><span class="p">[</span><span class="n">class_name</span><span class="p">])</span>
                    
                    <span class="k">except</span> <span class="p">(</span><span class="nb">OSError</span><span class="p">,</span> <span class="n">UnidentifiedImageError</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Skipping corrupted image: </span><span class="si">{</span><span class="n">img_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">image_paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">image_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">"RGB"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">transforms</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</code></pre></div></div>

<hr />

<h2 id="step-3-define-image-transformations">Step 3: Define Image Transformations</h2>

<p>Since VGG16 expects 224×224 RGB images, we resize and normalize using ImageNet 
statistics.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]</span>
<span class="n">std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>

<span class="n">transforms</span> <span class="o">=</span> <span class="n">v2</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">v2</span><span class="p">.</span><span class="n">PILToTensor</span><span class="p">(),</span>
    <span class="n">v2</span><span class="p">.</span><span class="n">ToDtype</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">v2</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)),</span>
    <span class="n">v2</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">),</span>
<span class="p">])</span>
</code></pre></div></div>

<hr />

<h2 id="step-4-create-dataset-and-dataloaders">Step 4: Create Dataset and DataLoaders</h2>

<p>We are splitting 80% of total data into training and rest 20% into testing set. Here,
I am using <code class="language-plaintext highlighter-rouge">BATCH_SIZE</code> of 16 but once comfortable you can play around with this 
parameter considering the GPU memory size to get better results.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DATASET_ROOT</span> <span class="o">=</span> <span class="s">"/content/kagglecatsanddogs_5340/PetImages"</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">CatDogDataset</span><span class="p">(</span><span class="n">DATASET_ROOT</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">)</span>

<span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
<span class="n">val_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>

<span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">train_size</span><span class="p">,</span> <span class="n">val_size</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Train dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Validation dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Train dataset: 19998</span>
<span class="c"># Validation dataset: 5000</span>
</code></pre></div></div>

<hr />

<h2 id="step-5-load-pretrained-vgg16">Step 5: Load Pretrained VGG16</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">"cpu"</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">models</span><span class="p">.</span><span class="n">VGG16_Weights</span><span class="p">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="step-6-freeze-feature-extractor-layers">Step 6: Freeze Feature Extractor Layers</h2>

<p>These are the layers of VGG16 network. And, its last classification layer has 1000
neurons for the categories of <a href="https://www.image-net.org/">ImageNet</a> challenge.</p>

<p><img src="/assets/img/vgg16-layers.png" alt="vgg16-layers" /></p>

<p><em>Source: https://arxiv.org/pdf/1409.1556</em></p>

<p>We freeze convolution layers so we only train the classifier, for us in the case of cats
and dogs classification should be 2.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="n">parameters</span><span class="p">():</span>
    <span class="n">param</span><span class="p">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="bp">False</span>
</code></pre></div></div>

<hr />

<h2 id="step-7-replace-final-classifier-layer">Step 7: Replace Final Classifier Layer</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">num_features</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">in_features</span>

<span class="n">model</span><span class="p">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_features</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="step-8-define-loss-and-optimizer">Step 8: Define Loss and Optimizer</h2>

<p>We are using <a href="https://docs.pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html">CrossEntropyLoss</a>
criterion to compute the cross entropy loss between input logits and target with fixed
learning rate of 0.001.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">0.001</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span>
    <span class="n">model</span><span class="p">.</span><span class="n">classifier</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span>
    <span class="n">lr</span><span class="o">=</span><span class="n">LEARNING_RATE</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="step-9-training-loop">Step 9: Training Loop</h2>

<p>We will train the model for 10 epochs. I train this notebook in  google colab L4 GPU 
but free tier GPU should be work.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">10</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
    <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
        
        <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span>
        
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="nb">sum</span><span class="p">().</span><span class="n">item</span><span class="p">()</span>
    
    <span class="n">train_acc</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Epoch [</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">EPOCHS</span><span class="si">}</span><span class="s">] "</span>
          <span class="sa">f</span><span class="s">"Loss: </span><span class="si">{</span><span class="n">running_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> "</span>
          <span class="sa">f</span><span class="s">"Train Acc: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%"</span><span class="p">)</span>

<span class="c1"># Epoch [1/10] Loss: 0.8439 Train Acc: 99.61%
# Epoch [2/10] Loss: 0.9217 Train Acc: 99.63%
# Epoch [3/10] Loss: 0.5612 Train Acc: 99.74%
# Epoch [4/10] Loss: 0.4510 Train Acc: 99.78%
# Epoch [5/10] Loss: 0.4539 Train Acc: 99.80%
# Epoch [6/10] Loss: 0.5069 Train Acc: 99.80%
# Epoch [7/10] Loss: 0.4641 Train Acc: 99.79%
# Epoch [8/10] Loss: 0.5079 Train Acc: 99.81%
# Epoch [9/10] Loss: 0.5364 Train Acc: 99.82%
# Epoch [10/10] Loss: 0.4578 Train Acc: 99.81%
</span></code></pre></div></div>

<hr />

<h2 id="step-10-validation">Step 10: Validation</h2>

<p>We evaluate the model’s performance in the validation dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
<span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="nb">sum</span><span class="p">().</span><span class="n">item</span><span class="p">()</span>

<span class="n">val_acc</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Validation Accuracy: </span><span class="si">{</span><span class="n">val_acc</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%"</span><span class="p">)</span>

<span class="c1"># Validation Accuracy: 98.72%
</span></code></pre></div></div>

<hr />

<h2 id="fine-tuning-for-maximum-performance">Fine Tuning for Maximum Performance</h2>

<p>So far, we trained only the new classifier head, while keeping the convolutional 
backbone frozen. This is often sufficient for many tasks. However, when the target 
dataset is significantly different from ImageNet, fine-tuning deeper layers can 
substantially improve accuracy.</p>

<p>Fine-Tuning works because pre-trained networks learn generic low-level features
in early layers like edges, colors, textures and task specific high level features
in deeper layers like shape, object parts and semantic structures.</p>

<p>For cats vs dogs, the low-level features are transferable, but high-level features 
such as fur patterns, ear shapes, and facial geometry benefit from fine-tuning.</p>

<hr />

<h2 id="fine-tuning-strategy">Fine-Tuning Strategy</h2>

<p>Instead of unfreezing the entire network, we:</p>

<ul>
  <li>Freeze early layers</li>
  <li>Unfreeze only the deeper layers</li>
  <li>Train with a very small learning rate</li>
</ul>

<p>This avoids catastrophic forgetting, overfitting and training instability.</p>

<hr />

<h2 id="selective-layer-unfreezing">Selective Layer Unfreezing</h2>

<p>We unfreeze only the later convolution blocks of VGG16:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:].</span><span class="n">parameters</span><span class="p">():</span>
    <span class="n">param</span><span class="p">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p>Since we’re modifying pretrained weights, we reduce learning rate:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</code></pre></div></div>]]></content><author><name></name></author><summary type="html"><![CDATA[Transfer learning is a powerful machine learning technique where a trained models’ parameters are reused instead of training from scratch in order to fine tune on specific dataset for specialized problem.]]></summary></entry><entry><title type="html">Minimax Algorithm: Understanding with Tic-Tac-Toe</title><link href="https://deshritbaral.com.np/blog/2024/11/11/minimax" rel="alternate" type="text/html" title="Minimax Algorithm: Understanding with Tic-Tac-Toe" /><published>2024-11-11T00:00:00+00:00</published><updated>2024-11-11T00:00:00+00:00</updated><id>https://deshritbaral.com.np/blog/2024/11/11/minimax</id><content type="html" xml:base="https://deshritbaral.com.np/blog/2024/11/11/minimax"><![CDATA[<p>Have you ever wondered how computers play games? And, surprising thing is they do win
with best possible results? You may say yeah that is whole points of computer - to solve
problems and do math, but shouldn’t there be some techniques because just 
having an oven and flour does not bake the bun itself.</p>

<p>Today, I will help you understand one of such game playing algorithm. The algorithm is
called <strong>minimax</strong> algorithm and is mostly used for the games where there 
are two players and players play turn by turn.</p>

<hr />

<h2 id="what-is-the-minimax-algorithm">What is the minimax algorithm?</h2>

<p>The <strong>minimax</strong> algorithm is a recursive decision-making algorithm. It is used in 
two-player turn-based games like chess and tic-tac-toe. Well, it sounds fancy but
the core logic is just playing all* possible moves and choosing the best result.</p>

<p>We should think it this way, suppose we have a game without any algorithm or anything,
one player plays a move so does the other, this continues, but the twist  is one of the
player implementing the algorithm (which is obvisously always the computer), plays all
possible states separately before playing its turn, checks the best result
and then plays the move, this does sounds very simple and lame because it is.</p>

<p>This algorithm, it assumes, it is the only one trying to win the game and the 
other is trying to not let them win. Suppose two players in a race, one is running 
to the endline while the other blocking the road rather than running itself. With this 
assumption, it calculates best possible result and plays that result in its turn. And 
it does this everytime because as the players play their move the state of the game 
changes.</p>

<p><em>Note: all* meaning sometimes it is not all possible moves but best moves up to 
certain depth.</em></p>

<hr />

<h2 id="implementing-only-the-tic-tac-toe">Implementing only the tic-tac-toe</h2>

<p>We will first start by only implementing the core game - a simple CLI program using 
<a href="https://www.python.org/downloads/">python</a>, the second best programming language in 
the world. We assume, <code class="language-plaintext highlighter-rouge">x</code> the <em>human player</em> and <code class="language-plaintext highlighter-rouge">o</code> is the <em>computer player</em> which 
will be the maximizing player playing with <strong>minimax</strong> algorithm as its brain.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">board</span> <span class="o">=</span> <span class="p">[</span><span class="s">" "</span><span class="p">]</span> <span class="o">*</span> <span class="mi">9</span>


<span class="k">def</span> <span class="nf">intro</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"""## TIC-TAC TUTORIAL ##

0 | 1 | 2
--+---+--
3 | 4 | 5
--+---+--
6 | 7 | 8

Enter 'q' to quit."""</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_board</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"--+---+--"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"--+---+--"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
</code></pre></div></div>

<p>The code here is fairly self explaining, just three objects, <code class="language-plaintext highlighter-rouge">board</code> array with default 
9 space <code class="language-plaintext highlighter-rouge">' '</code> values for 3 rows which will be filled by <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">o</code>, <code class="language-plaintext highlighter-rouge">intro</code> function 
for simple game introduction and <code class="language-plaintext highlighter-rouge">print_board</code> for printing current state of 
the board in console.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_winner</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">patterns</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>  <span class="c1"># rows
</span>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>  <span class="c1"># cols
</span>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],]</span>            <span class="c1"># diagonals
</span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s">" "</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">check_full</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">" "</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">board</span>
</code></pre></div></div>

<p>We are sure on how the game ends, either one player wins or there will be draw. 
To check that is to simply check if all values in one of the rows or cols or across 
two diagonals are same. The above mentioned <code class="language-plaintext highlighter-rouge">patterns</code> are the index of the <code class="language-plaintext highlighter-rouge">board</code> 
array satisfying these conditions. For the game to be draw we check if all the above 
cases fail with board being full.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">available_moves</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">board</span><span class="p">))</span> <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">" "</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_user_input</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"x </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">available_moves</span><span class="p">())</span><span class="si">}</span><span class="s">: "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="s">"q"</span><span class="p">:</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="s">" "</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">human_move</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">get_user_input</span><span class="p">()</span>
    <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s">"x"</span>
</code></pre></div></div>

<p>Also, these are functions are also fairly simple. <code class="language-plaintext highlighter-rouge">available_moves</code> - checks empty 
spaces in the <code class="language-plaintext highlighter-rouge">board</code>, <code class="language-plaintext highlighter-rouge">get_user_input</code> - function as name says gets valid input from 
the user from CLI, <code class="language-plaintext highlighter-rouge">human_move</code> - used alongside <code class="language-plaintext highlighter-rouge">get_user_input</code> - completing 
the user side of game playing logic.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">computer_move</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="s">" "</span><span class="p">:</span>
            <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s">"o"</span>
            <span class="k">break</span>
</code></pre></div></div>

<p>For the <em>computer player</em> we use random number generator for now.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">check_over</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">winner</span> <span class="o">=</span> <span class="n">get_winner</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"x"</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">## X WINNER ##"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"o"</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">## O WINNER ##"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">check_full</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">## DRAW :( ##"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>Also a basic function for better user experience. Combining all the above codes and
the <code class="language-plaintext highlighter-rouge">main</code> function from below to get basic <strong>tic-tac-toe</strong> implementation.</p>

<hr />

<h2 id="implementing-the-minimax-algorithm">Implementing the minimax algorithm</h2>

<p>Now the main part. The core <strong>minimax</strong> implementation for this game is just a simple
recursive function. If you are not 100% sure on recursive functions, you might want to
clear that confusion first. The important thing here is while the <code class="language-plaintext highlighter-rouge">minimax</code> function 
recursively calls itself, each call is simulating a different player’s move, which is here is 
checked by <code class="language-plaintext highlighter-rouge">is_max</code> flag parameter. This <code class="language-plaintext highlighter-rouge">is_max</code> parameter determines which player is 
moving currently and simulates all possible move taking maximum value if it true and minimum
otherwise.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">minimax</span><span class="p">(</span><span class="n">board</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">is_max</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">winner</span> <span class="o">=</span> <span class="n">get_winner</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"x"</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"o"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">check_full</span><span class="p">():</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">is_max</span><span class="p">:</span>  <span class="c1"># AI
</span>        <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100_000_000</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">available_moves</span><span class="p">():</span>
            <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">"o"</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">minimax</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">" "</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">best_score</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_score</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="mi">100_000_000</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">available_moves</span><span class="p">():</span>
            <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">"x"</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">minimax</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">" "</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">best_score</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_score</span>


<span class="k">def</span> <span class="nf">best_move</span><span class="p">():</span>
    <span class="n">move</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100_000_000</span>
    <span class="n">am</span> <span class="o">=</span> <span class="n">available_moves</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">am</span><span class="p">:</span>
        <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">"o"</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">minimax</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">" "</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">move</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">move</span>


<span class="k">def</span> <span class="nf">computer_move</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">best_move</span><span class="p">()</span>
    <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s">"o"</span>
</code></pre></div></div>

<hr />

<h2 id="combining-everything">Combining Everything</h2>

<p>Combining everything we explain in one place:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tic-tac-toe.py
</span>
<span class="n">board</span> <span class="o">=</span> <span class="p">[</span><span class="s">" "</span><span class="p">]</span> <span class="o">*</span> <span class="mi">9</span>

<span class="k">def</span> <span class="nf">intro</span><span class="p">():</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"""## TIC-TAC TUTORIAL ##

0 | 1 | 2
--+---+--
3 | 4 | 5
--+---+--
6 | 7 | 8

Enter 'q' to quit."""</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_board</span><span class="p">():</span>
  <span class="k">print</span><span class="p">()</span>
  <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"--+---+--"</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"--+---+--"</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">board</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
  <span class="k">print</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_winner</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
  <span class="n">patterns</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>  <span class="c1"># rows
</span>              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>  <span class="c1"># cols
</span>              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],]</span>            <span class="c1"># diagonals
</span>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s">" "</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">check_full</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
  <span class="k">return</span> <span class="s">" "</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">board</span>

<span class="k">def</span> <span class="nf">get_user_input</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
  <span class="n">ip</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"x </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">available_moves</span><span class="p">())</span><span class="si">}</span><span class="s">: "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="s">"q"</span><span class="p">:</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">()</span>
  <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="s">" "</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">human_move</span><span class="p">():</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">get_user_input</span><span class="p">()</span>
  <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s">"x"</span>

<span class="k">def</span> <span class="nf">available_moves</span><span class="p">():</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">board</span><span class="p">))</span> <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">" "</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">minimax</span><span class="p">(</span><span class="n">board</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">is_max</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
  <span class="n">winner</span> <span class="o">=</span> <span class="n">get_winner</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"x"</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">elif</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"o"</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1</span>
  <span class="k">elif</span> <span class="n">check_full</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">0</span>

  <span class="k">if</span> <span class="n">is_max</span><span class="p">:</span> <span class="c1"># AI
</span>    <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100_000_000</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">available_moves</span><span class="p">():</span>
      <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">"o"</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">minimax</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
      <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">" "</span>
      <span class="n">best_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">best_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best_score</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="mi">100_000_000</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">available_moves</span><span class="p">():</span>
      <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">"x"</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">minimax</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
      <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">" "</span>
      <span class="n">best_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">best_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best_score</span>

<span class="k">def</span> <span class="nf">best_move</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
  <span class="n">move</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100_000_000</span>
  <span class="n">am</span> <span class="o">=</span> <span class="n">available_moves</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">am</span><span class="p">:</span>
    <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">'o'</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">minimax</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">" "</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
      <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
      <span class="n">move</span> <span class="o">=</span> <span class="n">i</span>
  <span class="k">return</span> <span class="n">move</span>

<span class="k">def</span> <span class="nf">computer_move</span><span class="p">():</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">best_move</span><span class="p">()</span>
  <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s">"o"</span>

<span class="k">def</span> <span class="nf">check_over</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
  <span class="n">winner</span> <span class="o">=</span> <span class="n">get_winner</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"x"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">## X WINNER ##"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"o"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">## O WINNER ##"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">if</span> <span class="n">check_full</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">## DRAW :( ##"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">intro</span><span class="p">()</span>
  <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">print_board</span><span class="p">()</span>
    <span class="c1"># Human move
</span>    <span class="k">try</span><span class="p">:</span>
      <span class="n">human_move</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">** Invalid input **"</span><span class="p">)</span>
      <span class="k">continue</span>
    <span class="k">if</span> <span class="n">check_over</span><span class="p">():</span>
      <span class="k">break</span>
    <span class="c1"># AI move
</span>    <span class="n">computer_move</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">check_over</span><span class="p">():</span>
      <span class="k">break</span>

  <span class="n">print_board</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
  <span class="n">main</span><span class="p">()</span>

</code></pre></div></div>

<p>To run the game:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 tic-tac-toe.py
</code></pre></div></div>]]></content><author><name></name></author><category term="jekyll" /><category term="update" /><summary type="html"><![CDATA[Have you ever wondered how computers play games? And, surprising thing is they do win with best possible results? You may say yeah that is whole points of computer - to solve problems and do math, but shouldn’t there be some techniques because just having an oven and flour does not bake the bun itself.]]></summary></entry><entry><title type="html">Tuning a PID Controller</title><link href="https://deshritbaral.com.np/blog/2024/09/25/tuning-PID-controller" rel="alternate" type="text/html" title="Tuning a PID Controller" /><published>2024-09-25T00:00:00+00:00</published><updated>2024-09-25T00:00:00+00:00</updated><id>https://deshritbaral.com.np/blog/2024/09/25/tuning-PID-controller</id><content type="html" xml:base="https://deshritbaral.com.np/blog/2024/09/25/tuning-PID-controller"><![CDATA[<p>If you’ve ever tried to control the speed of a motor, balance a robot, or maintain a 
stable temperature with an Arduino or any other micro-controller, chances are you’ve 
come across something called a <strong>PID controller</strong>. At first, PID might look complicated 
with all its math and jargon—but its actually a simple concept! Today, I will 
break it down for you in simple terms so that you can quickly learn how to implement 
it in your own projects.</p>

<hr />

<h2 id="what-is-a-pid-controller">What is a PID Controller?</h2>

<p>PID stands for:</p>
<ul>
  <li><strong>P</strong>: Proportional</li>
  <li><strong>I</strong>: Integral</li>
  <li><strong>D</strong>: Derivative</li>
</ul>

<p>Think of it like this:</p>

<ul>
  <li><strong>P</strong> is how hard you push toward your goal.</li>
  <li><strong>I</strong> keeps track of how far you’ve been off the goal over time and nudges you to 
fix it.</li>
  <li><strong>D</strong> watches how fast you’re approaching the goal and prevents you from overshooting.</li>
</ul>

<p>All three work together to reach your target smoothly and accurately.</p>

<hr />

<h2 id="implementing-pid-controller-in-code">Implementing PID Controller in Code</h2>

<p>Writing the PID logic in code has to be the easiest part of all. There are only few 
thing to keep in mind.</p>

<ul>
  <li>Constant main loop</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loop_timer</span><span class="p">;</span>

<span class="n">loop_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="cm">/* Read sensor value */</span>

  <span class="cm">/* PID code */</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">micros</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_timer</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">);</span>
  <span class="n">loop_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Calculate error</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">error</span><span class="p">,</span> <span class="n">prev_error</span><span class="p">;</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">set_point</span> <span class="o">-</span> <span class="n">sensor_value</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Calculate <strong>p</strong> value</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">p</span><span class="p">;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">kp</span> <span class="o">*</span> <span class="n">error</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Calculate <strong>d</strong> value</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">d</span><span class="p">;</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">kd</span> <span class="o">*</span> <span class="p">(</span><span class="n">prev_error</span> <span class="o">-</span> <span class="n">error</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Calculate <strong>i</strong> value</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">i</span><span class="p">;</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">error</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Total PID value</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">output</span><span class="p">;</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">d</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<h2 id="tuning-the-pid-constants">Tuning the PID Constants</h2>

<p>Now all you have to do is change the values of <code class="language-plaintext highlighter-rouge">kp</code>, <code class="language-plaintext highlighter-rouge">ki</code> and <code class="language-plaintext highlighter-rouge">kd</code> such that you get 
desired output from your system.</p>

<ol>
  <li>
    <p>Start with only one constant <code class="language-plaintext highlighter-rouge">kp</code>, like <code class="language-plaintext highlighter-rouge">kp = 2.0, ki = 0, kd = 0</code> and observe the 
output. Tweak this value so that you get optimum possible outcome.</p>
  </li>
  <li>
    <p>Next, start assuming <code class="language-plaintext highlighter-rouge">kd,</code> yeah <code class="language-plaintext highlighter-rouge">kd</code> not <code class="language-plaintext highlighter-rouge">ki</code>. We secondly tune <code class="language-plaintext highlighter-rouge">kd</code> because, it 
dampens the over and under shoot created by <code class="language-plaintext highlighter-rouge">kp</code>. You might need to go back to <code class="language-plaintext highlighter-rouge">kp</code> 
and tweak it to tune this value properly.</p>
  </li>
  <li>
    <p>Finally, tune the <code class="language-plaintext highlighter-rouge">ki</code>. For the many systems you might not even need <code class="language-plaintext highlighter-rouge">ki</code>. You have 
to think slightly differently for constant <code class="language-plaintext highlighter-rouge">ki</code> because if you see above mathematical 
expression for the value associated with <code class="language-plaintext highlighter-rouge">ki</code> which is—<code class="language-plaintext highlighter-rouge">i</code>, depends on previous values 
of <code class="language-plaintext highlighter-rouge">i</code> meaning it is integrating all the values over many loops whereas for <code class="language-plaintext highlighter-rouge">d</code> you 
only need what previous <code class="language-plaintext highlighter-rouge">error</code> value was, meaning it is accounting for how large the 
difference in <code class="language-plaintext highlighter-rouge">error</code> is between the loops and finally for <code class="language-plaintext highlighter-rouge">kp</code>, it just needs the 
current <code class="language-plaintext highlighter-rouge">error</code>.</p>
  </li>
</ol>

<hr />

<h2 id="other-important-points">Other Important Points</h2>

<ol>
  <li>
    <p>Calibrating the sensor—You might need to add offset values depending upon the type 
and quality of sensor used in the project.</p>
  </li>
  <li>
    <p>Skip the processing in deadzone—As we know the total PID value is the direct output 
to the actuator, suppose, for a balancing robot in a <em>single axis</em>, if the sensor 
output value in degree is \(0^\circ\) when perfectly vertical, then possible deadzone 
range (depending upon the type of sensors, motors etc.) can be \(\pm2^\circ\), where 
processing the PID value can be completely skipped and simply set to 0.</p>
  </li>
  <li>
    <p>Also Keep in account for the actuator deadzone—If you are using an arduino to drive 
a motor with a motor driver, you have to give out PWM value from any analog pin to the 
driver, which generally in code value from 0 to 255 and you might have noticed the 
motor does not immediately start moving in initial values maybe even for upto 10 or 20, 
this maximum value until when the motor does not start moving is the actuator deadzone. 
And to fix this problem simply add this value 20 to PID output or you can also map your 
PID value to range 20 to 255 of motor driver output.</p>
  </li>
  <li>
    <p>Clamp the PID value to your actuator range—Suppose if your total PID value came out 
to be 257 to give it to your motor driver which should be only between range 0 to 255, 
the value might overflow as 2. So better clamp the value \(\gt\) 255 to 255 and 
\(\lt\) 0 to 0.</p>
  </li>
</ol>

<hr />

<h2 id="combining-everything">Combining Everything</h2>

<p>A typical setup looks like this:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Arduino.h&gt;</span><span class="cp">
</span>
<span class="cm">/* Required variables */</span>
<span class="kt">float</span> <span class="n">sensor_value</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">set_point</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">prev_error</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loop_timer</span><span class="p">;</span>

<span class="cm">/* PID parameters */</span>
<span class="kt">float</span> <span class="n">Kp</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">Kd</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

<span class="cm">/* Utility functions */</span>
<span class="kt">float</span> <span class="nf">read_sensor</span><span class="p">()</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="n">drive_motor</span><span class="p">(</span><span class="kt">float</span> <span class="n">value</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="cm">/* Required setup code ... */</span>
  
  <span class="n">loop_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="cm">/* Read sensor value */</span>
  <span class="n">sensor_value</span> <span class="o">=</span> <span class="n">read_sensor</span><span class="p">();</span>

  <span class="cm">/* PID code */</span>
  <span class="n">error</span> <span class="o">=</span> <span class="n">set_point</span> <span class="o">-</span> <span class="n">sensor_value</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">kp</span> <span class="o">*</span> <span class="n">error</span><span class="p">;</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">kd</span> <span class="o">*</span> <span class="p">(</span><span class="n">prev_error</span> <span class="o">-</span> <span class="n">error</span><span class="p">);</span>
  <span class="n">prev_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">error</span><span class="p">;</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">d</span><span class="p">;</span>

  <span class="cm">/* Driving the actuator */</span>
  <span class="n">drive_motor</span><span class="p">(</span><span class="n">output</span><span class="p">);</span>

  <span class="cm">/* Constant 250Hz main loop */</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">micros</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_timer</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">);</span>
  <span class="n">loop_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>]]></content><author><name></name></author><category term="jekyll" /><category term="update" /><summary type="html"><![CDATA[If you’ve ever tried to control the speed of a motor, balance a robot, or maintain a stable temperature with an Arduino or any other micro-controller, chances are you’ve come across something called a PID controller. At first, PID might look complicated with all its math and jargon—but its actually a simple concept! Today, I will break it down for you in simple terms so that you can quickly learn how to implement it in your own projects.]]></summary></entry></feed>